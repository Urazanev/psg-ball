# Simple Pinball - полный разбор текущей версии (для геймдизайна)

## 1) Что это за игра

`Simple Pinball` в текущем состоянии - это аркадный пинбол с мета-слоем:

- В рантайме игрок набирает `Score`, управляя флипперами, плунжером и наклоном стола.
- Вне рана (и частично в рантайме через UI) игрок тратит `Tickets` на ящики (`crates`) и собирает перки.
- Перки складываются в очередь из 3 слотов и активируются вручную во время игры.

Ключевой текущий режим проекта: **упрощённый perks-lite** (ачивки и часть старых систем фактически выключены).

## 2) Высокоуровневый игровой цикл

1. Игрок на главном экране нажимает `Play`.
2. Запускается ран:
- сбрасывается `Score` в `0`;
- выставляется множитель `1.0x`;
- задаётся запас жизней/мячей через счётчик `Lives`.
3. После старта спавнится шар, игрок играет.
4. За столкновения с scoring-объектами идёт прирост `Score`.
5. Со временем при живом и движущемся шаре растёт `Multiplier`.
6. При достижении score-порогов выдаются `Tickets`.
7. Если шар(ы) покинули поле, через задержку списывается жизнь и спавнится следующий шар (или `Game Over`).
8. В `Game Over` можно `Play Again` или принудительно `Reset` (discard balls).

## 3) Экраны и UI

## 3.1 Главный экран (`Play Panel`)

Это основной экран перед стартом рана, он же сейчас "центр меты".

Что есть на экране:

- Заголовок `Simple Pinball`.
- Кнопка `Reset progress` (удаляет прогресс через `PlayerPrefs.DeleteAll()` и перезагружает сцену).
- Блок `Ticket Store` с билетами и ящиками.
- Кнопка `Play`.
- Кнопка `Controls` (открывает оверлей с подсказками управления).
- `Connect Wallet` (создаётся рантаймом, показывается только когда открыт Main Menu).

Что убрано на этом экране:

- Заголовок `Achievements` скрывается.
- Панель achievements скрывается.
- `Golden Crate` скрыт.

## 3.2 Экран подсказок `Controls` (Tutorial overlay)

Открывается кнопкой `Controls` на главном экране, закрывается кнопкой `Close`.

Текстовые блоки в оверлее (что видит игрок):

- `Activate powerup` - клавиша `CTRL`
- `Use Plunger` - клавиша `SPACE`
- `Right Flipper` - клавиши `D` или `→`
- `Left Flipper` - клавиши `A` или `←`
- `Tilt the machine` - клавиши `LSHIFT` и `RSHIFT`

Важно:

- Это именно UI-подсказки текущей сцены.
- На PSG1 реальные бинды другие (ниже есть отдельная таблица).

## 3.3 Игровой HUD (во время рана)

Во время игры отображается:

- Слева сверху: 3 слота перков (очередь предметов).
- Рядом: текущие `Tickets`.
- Справа сверху: `Score`.
- Под score: текущий `Multiplier` (`x`).
- Справа снизу: `Balls` + число оставшихся жизней/мячей.

Дополнительно:

- Поддерживается пауза (`Pause`) с панелью `Game Paused`.
- Есть срабатывание auto-pause при потере фокуса приложения.

## 3.4 Пауза (`Pause Panel`)

Появляется по `Esc` (клавиатура) или `Start` (PSG1/Gamepad).

Элементы:

- Заголовок `Game Paused`.
- `Volume` slider (меняет `AudioListener.volume`).
- Кнопка `Return` (снимает паузу, `Time.timeScale = 1`).

## 3.5 `Game Over` панель

Показывается после исчерпания жизней:

- Текст `Game Over!` + итоговый score.
- `Play Again` (возвращает на главный экран / play panel).
- `Reset` с текстом `Discard Balls` (принудительно обнуляет жизни и удаляет шары).
- Поле с локальным session-листом результатов (`Leaderboard` в памяти с сортировкой по score).

Важно:

- Лидерборд в этой версии **не персистится** между запусками, хранится в статическом списке в памяти процесса.

## 4) Управление (фактическая логика)

## 4.1 Клавиатура (fallback + editor)

- Левый флиппер: `A` или `Left Arrow`
- Правый флиппер: `D` или `Right Arrow`
- Плунжер:
- `Space` down -> начать натяжение
- `Space` hold -> накапливать силу
- `Space` up -> отпустить шар
- Пауза: `Esc`
- Наклон влево: `Left Shift`
- Наклон вправо: `Right Shift`
- Использовать перк: `Left Ctrl` (или `Left Apple` на mac)

## 4.2 PSG1 / Gamepad (New Input System)

Action map: `PSG1Controls > Gameplay`

- `LeftFlipper` -> `leftShoulder` (`L1`)
- `RightFlipper` -> `rightShoulder` (`R1`)
- `Plunger` -> `buttonSouth` (`A`)
- `Pause` -> `start`
- `NudgeLeft` -> `dpad/left`
- `NudgeRight` -> `dpad/right`
- `UseItem` -> `buttonWest` (`X`)

Приоритет ввода:

- Если подключён геймпад с именем/дескриптором `PSG1`, берётся только геймпадный input.
- Иначе работают input action + клавиатурный fallback.

## 5) Очки, множитель, билеты

## 5.1 Score

Score увеличивается при ударах по объектам со `ScoringObject.IncrementValue`.

Формула на событие:

- `Score += (int)(IncrementValue * Multiplier)`

## 5.2 Multiplier

- Сбрасывается до `1.0x` при изменении `Lives` (в том числе при потере шара).
- Пока на поле есть движущийся шар:
- каждые `10` секунд множитель растёт на `+0.1`.

## 5.3 Tickets (экономика)

Tickets копятся двумя путями:

1. Порогами score:
- Параметр `TicketEarningFactor = 500`.
- Когда score пересекает следующий порог `lastTicketIncrement + (500 * Multiplier)`, даётся `+1` ticket.
2. Через эффекты некоторых перков (например `Ticket Prize`).

Важно:

- Текущий счёт tickets сохраняется в `PlayerPrefs` (`ticketCount`).

## 6) Жизни, спавн шаров, конец игры

- `GameStart()` выставляет `Lives = 4`.
- Когда на поле нет шаров, через `0.8s`:
- `Lives -= 1`
- снимается активный перк (`OnDeath()` + `Unequip()`)
- если после списания `Lives < 0` -> `Game Over`
- иначе спавнится новый шар.

Практический итог:

- На один ран получается до 4 игровых шаров.
- При каждом дропе шара активный перк сбрасывается.

## 7) Магазин и ящики (crates)

## 7.1 Что делает кнопка на ящике

При нажатии на карточку ящика:

1. Проверяется, хватает ли `Tickets`.
2. Проверяется, есть ли свободный слот в очереди (3 слота).
3. Если условий нет -> fail sound, покупка не происходит.
4. Если условия есть:
- tickets списываются,
- по таблице редкости выбирается случайный предмет,
- предмет кладётся в первый пустой слот.

## 7.2 Стоимости

- `Rusty Crate` - `3` tickets
- `Brass Crate` - `6` tickets
- `Golden Crate` - `10` tickets (**скрыт в текущем UI**)

## 7.3 Случайность дропа

Дроп идёт через weighted random (инцидентности/веса), без защиты от дублей.

То есть:

- можно получить 2-3 одинаковых перка подряд;
- выпадение зависит только от весов выбранного ящика.

## 7.4 Текущие loot tables (Perks Lite)

Сейчас активна упрощённая таблица (`UsePerksLiteLootTables = true`).

`Rusty` (сумма весов = 14):

- Camera Flip: 4 (28.57%)
- Ping Pong: 4 (28.57%)
- Tennis Ball: 3 (21.43%)
- Health Bonus: 2 (14.29%)
- Ticket Prize: 1 (7.14%)

`Brass` (сумма весов = 16):

- Camera Flip: 2 (12.5%)
- Ping Pong: 2 (12.5%)
- Tennis Ball: 2 (12.5%)
- Angel Wings: 2 (12.5%)
- Extra Ball: 3 (18.75%)
- Health Bonus: 2 (12.5%)
- Ticket Prize: 3 (18.75%)

`Golden` (в коде есть, но скрыт в UI):

- Angel Wings: 2
- Extra Ball: 3
- Health Bonus: 2
- Ticket Prize: 3

## 8) Слоты перков: что это за "3 окошка"

Игрок видит 3 слота (очередь):

- `Slot 1` - следующий к использованию
- `Slot 2` - второй в очереди
- `Slot 3` - третий в очереди

При `UseItem`:

- берётся предмет из `Slot 1`,
- `Slot 2` сдвигается в `Slot 1`,
- `Slot 3` сдвигается в `Slot 2`,
- `Slot 3` очищается.

Ограничения использования:

- если на поле нет шаров -> перк не активируется,
- если `Slot 1` пуст -> не активируется,
- если уже есть активный перк (`Equipped != NoItem`) -> новый не активируется.

Следствие:

- можно накопить очередь заранее,
- но одновременно активен только 1 перк.

## 9) Какие перки реально работают в текущем продукте

Ниже "фактический эффект из кода" + пользовательский смысл.

## 9.1 Перки, которые сейчас выпадают из crates

1. `Ping Pong`
- UX-описание: "Insane flipper force..."
- Факт: поднимает силу/скорость флипперов (`1500/150` -> `2500/250`) пока активен.

2. `Health Bonus`
- UX-описание: +1 life сразу + шанс на life при scoring.
- Факт:
- при активации `Lives += 1`
- на каждое scoring-событие шанс `1/50` (2%) на ещё `+1 life`.

3. `Tennis Ball`
- UX-описание: снижает шанс Tilt fail до 5%.
- Факт: `TiltChance = 20` (в коде это снижает шанс срабатывания tilt, т.к. tilt на `Random.Range(0, TiltChance)==0`).

4. `Camera Flip`
- UX-описание: переворот камеры + небольшой буст множителя.
- Факт: поворачивает камеру на 180 по Z и даёт `+1.5` к `Multiplier`; снимается при unequip.

5. `Ticket Prize`
- UX-описание: случайные tickets + шанс на tickets при scoring.
- Факт:
- при активации `+3..5` tickets (`Random.Range(3,6)`)
- на scoring шанс `1/10` (10%) получить `+1` ticket.

6. `Angel Wings` (выпадает из Brass)
- UX-описание: "ghost + teleport to spawnpoint".
- Факт: для всех шаров обнуляет скорость и телепортирует в spawnpoint.

7. `Extra Ball` (выпадает из Brass)
- UX-описание: summons another ball.
- Факт: сразу спавнит дополнительный шар.

## 9.2 Перки в проекте, но не в текущем lite-дропе

Присутствуют как ассеты/скрипты, но сейчас не выпадают из Rusty/Brass из-за lite-таблиц:

- Fireball
- Water Droplet
- Lucky Charm
- Rock
- Curse of Anubis

Часть из них имеет только data-описание/материалы, часть имеет активную логику (например `Lucky Charm`, `Curse of Anubis`), но в текущем UX-потоке они выключены через loot table.

## 10) Achievements - текущий статус

Система ачивок оставлена в проекте, но сейчас фактически выключена:

- `Achievements.Enabled => false`
- UI ачивок скрывается
- выдача/прогресс ачивок не участвуют в текущем геймплее

То есть это "технический долг/legacy блок", не активная фича продукта сейчас.

## 11) Wallet Connect - текущий статус

- Кнопка `Connect Wallet` создаётся скриптом в рантайме.
- Отображается только когда открыт `Play Panel` (главный экран).
- В Editor работает mock-address (для локальной проверки UI).
- На девайсе ожидается реальный adapter-flow через Solana SDK.
- В этой версии игра не делает обязательных транзакций для базового цикла.

## 12) Hover/подсказки в UI

- На иконках предметов (в карточках ящиков и слотах) висят hover-события (`EventTrigger`), которые:
- заполняют `InfoName` и `InfoDescription`,
- открывают/закрывают информационный popover.
- Аналогично у achievements-иконок есть hover-логика в сцене, но она незначима при выключенной achievements-системе.

## 13) Что важно дизайнеру учитывать в редизайне

1. База механики:
- Пинбол + ticket economy + ручная активация перков (3-slot queue).

2. Что можно смело не проектировать как core:
- achievements (сейчас выключены),
- golden crate (скрыт),
- legacy-перки вне lite-таблиц.

3. Критичные UX-узлы:
- понятность очереди из 3 слотов (что активируется только первый),
- понятность "когда и как жать use item",
- объяснение, почему может выпадать дубликат перка,
- ясная связка `Score -> Tickets`.

4. Технические инварианты, которые уже есть:
- один активный перк за раз,
- перк сбрасывается при потере шара,
- pause/volume доступны всегда в ране,
- wallet-кнопка только на главном экране.

## 14) Короткий "гайд игроку" (как играть в текущей версии)

1. На главном экране купи ящик за tickets (по желанию), чтобы заполнить слоты перков.
2. Нажми `Play`.
3. Держи `Space` (или `A` на PSG1) для силы плунжера, отпусти для запуска шара.
4. Управляй флипперами (`A/D` или `L1/R1` на PSG1).
5. При необходимости используй наклон (`Shift` / dpad left-right), но можно поймать `Tilt`.
6. Когда в первом слоте есть перк и шар на поле - жми `UseItem` (`Ctrl` / `X` на PSG1).
7. Набирай score, чтобы получать tickets, и повторяй цикл.

---

Документ описывает **фактическое поведение текущего билда в репозитории**, а не целевой дизайн.
